<div class="container mt-4" [attr.aria-busy]="isLoading">
  <div class="card shadow-sm mb-3">
    <div class="card-body">

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-outline-secondary btn-sm" (click)="toggleFilters()" [disabled]="isLoading">
          <i class="bi bi-funnel me-1"></i> Bộ lọc
        </button>

        <div class="flex-grow-1" style="min-width: 280px;">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input class="form-control border-start-0" placeholder="Tìm theo tên file…" [formControl]="q"
              [disabled]="isLoading">
          </div>
        </div>
      </div>

      <div *ngIf="showFilters" class="mt-3">
        <div class="row g-2">
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Trạng thái</label>
            <select class="form-select form-select-sm" [formControl]="statusSel" [disabled]="isLoading">
              <option value="ALL">Tất cả</option>
              <option value="APPROVED">Duyệt</option>
              <option value="REJECTED">Hủy</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label mb-1">Môn học (tên / mã)</label>
            <input class="form-control form-control-sm" [formControl]="subjectText"
              placeholder="VD: CS101 hoặc Data Structures" [disabled]="isLoading">
          </div>

          <!-- Từ ngày -->
          <mat-form-field appearance="outline" class="w-100 dense-field" subscriptSizing="dynamic">
            <input matInput [matDatepicker]="fromPicker" [formControl]="from" [disabled]="isLoading">
            <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
            <mat-datepicker #fromPicker></mat-datepicker>
          </mat-form-field>

          <!-- Đến ngày -->
          <mat-form-field appearance="outline" class="w-100 dense-field" subscriptSizing="dynamic">
            <input matInput [matDatepicker]="toPicker" [formControl]="to" [disabled]="isLoading">
            <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
            <mat-datepicker #toPicker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="mt-2 d-flex justify-content-end gap-2">
          <button class="btn btn-sm btn-outline-secondary" (click)="clearClientFilters()" [disabled]="isLoading">
            <i class="bi bi-x-circle"></i> Xoá bộ lọc
          </button>
          <button class="btn btn-sm btn-primary" (click)="applyFilters()" [disabled]="isLoading">Áp dụng</button>
        </div>
      </div>
    </div>
  </div>

  <div class="position-relative">
    <div class="table-responsive border rounded">
      <table mat-table [dataSource]="rows" class="mat-elevation-z0 mb-0">

        <!-- Filename -->
        <ng-container matColumnDef="filename">
          <th mat-header-cell *matHeaderCellDef>Tên file</th>
          <td mat-cell *matCellDef="let r">
            <div class="d-flex align-items-center gap-2">
              <i [class]="iconClass(r)"></i>
              <span class="fw-semibold">{{ r.filename }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Subject -->
        <ng-container matColumnDef="subject">
          <th mat-header-cell *matHeaderCellDef>Môn học</th>
          <td mat-cell *matCellDef="let r">{{ r.subjectName || ('#' + r.subjectId) }}</td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Trạng thái</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="statusBadge(r.reviewStatus)" [matTooltip]="rejectTooltip(r)">
              {{ (r.reviewStatus || '—') }}
            </span>
          </td>
        </ng-container>

        <!-- Reviewer -->
        <ng-container matColumnDef="reviewer">
          <th mat-header-cell *matHeaderCellDef>Người duyệt</th>
          <td mat-cell *matCellDef="let r">{{ r.reviewedByName || '—' }}</td>
        </ng-container>

        <!-- ReviewedAt -->
        <ng-container matColumnDef="reviewedAt">
          <th mat-header-cell *matHeaderCellDef>Thời điểm duyệt</th>
          <td mat-cell *matCellDef="let r">{{ r.reviewedAt | date:'dd/MM/yyyy, HH:mm' }}</td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="text-end col-actions">Thao tác</th>
          <td mat-cell *matCellDef="let r" class="text-end col-actions">
            <button mat-button color="primary" (click)="view(r, $event)" [disabled]="isLoading">
              <mat-icon>open_in_new</mat-icon> Xem
            </button>
            <button mat-button color="accent" (click)="download(r, $event)"
              [disabled]="isLoading || downloading.has(r.id)">
              <mat-icon>download</mat-icon> Tải về
            </button>
            <button mat-button color="warn" (click)="confirmDelete(r, $event)" [disabled]="isLoading">
              <mat-icon>delete</mat-icon> Xóa
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns" (click)="openInfo(row)" style="cursor:pointer"></tr>

        <tr *ngIf="!isLoading && rows.length === 0">
          <td [attr.colspan]="displayedColumns.length" class="text-center py-4 text-muted">
            Chưa có lịch sử.
          </td>
        </tr>
      </table>
    </div>

    <mat-paginator [length]="total" [pageIndex]="pageIndex" [pageSize]="pageSize" [pageSizeOptions]="[10,20,50]"
      (page)="onPage($event)" class="mt-2">
    </mat-paginator>
  </div>
</div>

<!-- Overlay loading mới -->
<app-loading-screen *ngIf="isLoading"></app-loading-screen>