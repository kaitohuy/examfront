<h2 class="m-3" mat-dialog-title>
  <ng-container *ngIf="mode==='export'; else autogenTitle">
    Xuất file các câu hỏi đã chọn
    <small class="text-muted">({{data.selectedCount}} câu hỏi)</small>
  </ng-container>
  <ng-template #autogenTitle> Sinh đề tự động </ng-template>
</h2>

<mat-dialog-content class="content pt-2">

  <!-- ================== ROW ĐẦU TIÊN ================== -->
  <!-- export: loại, tên file, định dạng (GIỮ NGUYÊN) -->
  <ng-container *ngIf="mode==='export'">
    <div class="row g-3 align-items-end mb-2">
      <div class="col-12 col-md-3">
        <label class="form-label">Loại</label>
        <select class="form-select" [(ngModel)]="variant" (change)="onVariantChange()">
          <option value="practice">Ôn tập</option>
          <option value="exam">Đề thi</option>
        </select>
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label">Tên file</label>
        <div class="input-group">
          <input class="form-control" [placeholder]="variant==='practice' ? 'on-tap' : 'de-thi'" [(ngModel)]="fileName">
          <button class="btn btn-outline-secondary" type="button" *ngIf="fileName" (click)="clearFileName()" aria-label="Xoá tên file">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">Định dạng</label>
        <select class="form-select" [(ngModel)]="format">
          <option value="pdf">PDF</option>
          <option value="docx">Word (.docx)</option>
        </select>
      </div>
    </div>
  </ng-container>

  <!-- autogen: số lượng, tên file, loại (auto chọn exam), định dạng (auto chọn word) -->
  <ng-container *ngIf="mode==='autogen'">
    <div class="row g-3 align-items-end mb-2">
      <div class="col-12 col-md-3">
        <label class="form-label">Số lượng đề <span class="text-danger">*</span></label>
        <input class="form-control" type="number" min="1" [(ngModel)]="variants"
               [class.is-invalid]="submitted && (!variants || variants<1)">
        <div *ngIf="submitted && (!variants || variants<1)" class="invalid-feedback d-block">Số lượng phải ≥ 1</div>
      </div>

      <div class="col-12 col-md-5">
        <label class="form-label">Tên file (.zip)</label>
        <div class="input-group">
          <input class="form-control" placeholder="de_tu_dong" [(ngModel)]="fileName">
          <button class="btn btn-outline-secondary" type="button" *ngIf="fileName" (click)="clearFileName()" aria-label="Xoá tên file">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Loại</label>
        <select class="form-select" [(ngModel)]="variant" (change)="onVariantChange()">
          <!-- vẫn cho chọn, nhưng đã auto chọn 'exam' -->
          <option value="practice">Ôn tập</option>
          <option value="exam">Đề thi</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Định dạng</label>
        <select class="form-select" [(ngModel)]="format">
          <option value="pdf">PDF</option>
          <option value="docx">Word</option>
        </select>
      </div>
    </div>
  </ng-container>

  <!-- ================== HEADER ĐỀ THI ================== -->
  <!-- GIỮ NGUYÊN UI, nhưng ẨN ô MÃ ĐỀ nếu mode='autogen' -->
  <div *ngIf="variant==='exam'" class="mt-3">
    <div class="border rounded p-3">
      <div class="fw-semibold mb-3"><i class="bi bi-sliders"></i> Header đề thi</div>

      <div class="row g-3">
        <div class="col-12 col-md-3">
          <label class="form-label">Học kỳ</label>
          <select class="form-select" [(ngModel)]="semester" (ngModelChange)="onSemesterChange()">
            <option value="">(bỏ trống)</option>
            <option value="I">I</option>
            <option value="II">II</option>
            <option value="Hè">Hè</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Năm học</label>
          <input class="form-control" placeholder="2024-2025" [(ngModel)]="academicYear">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Lớp</label>
          <input name="classes" class="form-control" placeholder="D18CN, D18AT" [(ngModel)]="classes"/>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Thời lượng (phút)</label>
          <input class="form-control" type="number" min="1" [(ngModel)]="durationMinutes">
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12 col-md-3">
          <label class="form-label">khoa</label>
          <input name="faculty" class="form-control" [(ngModel)]="program"/>
        </div>

        <!-- MÃ ĐỀ: chỉ hiện ở export mode -->
        <div class="col-12 col-md-3" *ngIf="mode==='export'">
          <label class="form-label">Mã đề</label>
          <input class="form-control" type="number" min="1" [(ngModel)]="paperNo">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Hình thức thi</label>
          <select class="form-select" [(ngModel)]="examForm">
            <option value="viết">Viết</option>
            <option value="trắc nghiệm">Trắc nghiệm</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Mẫu</label>
          <input class="form-control"[(ngModel)]="mau">
        </div>
      </div>
    </div>
  </div>

  <!-- ================== CHECKBOX FOOTER ================== -->
  <!-- export: giữ nguyên; autogen: ẩn hoàn toàn -->
  <ng-container *ngIf="mode==='export'">
    <div class="d-flex flex-wrap align-items-center gap-4 mt-3">
      <div class="form-check">
        <input id="incAns" class="form-check-input item-checkbox" type="checkbox" [(ngModel)]="includeAnswers">
        <label for="incAns" class="form-check-label">Bao gồm đáp án</label>
      </div>

      <div class="form-check">
        <input id="saveCopy" class="form-check-input item-checkbox" type="checkbox" [(ngModel)]="saveCopy">
        <label for="saveCopy" class="form-check-label">Lưu vào kho lưu trữ</label>
      </div>
    </div>
  </ng-container>

</mat-dialog-content>

<mat-dialog-actions align="end">
  <button type="button" mat-stroked-button (click)="onCancel()">Hủy</button>
  <button type="button" mat-flat-button color="primary" (click)="submit()">
    <mat-icon>{{ mode==='export' ? 'download' : 'auto_fix_high' }}</mat-icon>
    <span class="ms-1">{{ mode==='export' ? 'Xuất file' : 'Sinh & Tải về' }}</span>
  </button>
</mat-dialog-actions>
