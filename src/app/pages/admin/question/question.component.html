<!-- Thanh công cụ: tìm kiếm + bộ lọc + chọn tất cả -->
<div class="card shadow-sm mb-4" [attr.aria-busy]="isLoading">
  <div class="card-body">

    <!-- Toolbar -->
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <!-- Search -->
      <div class="flex-grow-1" style="min-width: 280px;">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control border-start-0" placeholder="Tìm kiếm câu hỏi..."
            [(ngModel)]="searchText" (input)="onSearchInput()" [disabled]="isLoading" />
        </div>
      </div>

      <!-- Filter dropdown -->
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
          data-bs-auto-close="false" #filterDropdown (click)="syncPendingFromActive()" [disabled]="isLoading">
          <i class="bi bi-funnel me-1"></i> Bộ lọc
          <span *ngIf="hasPendingChanges()" class="badge bg-warning text-dark ms-1">!</span>
        </button>

        <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 360px;">

          <div class="row g-2">
            <div class="mb-3">
              <label class="form-label mb-1">Báo lỗi</label>
              <select class="form-select" [(ngModel)]="pendingFilters.flagged" (click)="$event.stopPropagation()"
                [disabled]="isLoading">
                <option [ngValue]="null">Tất cả</option>
                <option [ngValue]="true">Chỉ bị báo lỗi</option>
                <option [ngValue]="false">Không bị báo lỗi</option>
              </select>
            </div>

            <div class="mb-3 col-6">
              <label class="form-label mb-1">Độ khó (điểm số)</label>
              <select class="form-select" [(ngModel)]="pendingFilters.difficulty" (click)="$event.stopPropagation()"
                [disabled]="isLoading">
                <option value="">Tất cả</option>
                <option value="A">(5 điểm)</option>
                <option value="B">(4 điểm)</option>
                <option value="C">(3 điểm)</option>
                <option value="D">(2 điểm)</option>
                <option value="E">(1 điểm)</option>
              </select>
            </div>

            <div class="mb-3 col-6">
              <label class="form-label mb-1">Chương</label>
              <select class="form-select" [(ngModel)]="pendingFilters.chapter" (click)="$event.stopPropagation()"
                [disabled]="isLoading">
                <option [ngValue]="null">Tất cả</option>
                <option [ngValue]="0">Chưa phân loại</option>
                <option [ngValue]="1">1</option>
                <option [ngValue]="2">2</option>
                <option [ngValue]="3">3</option>
                <option [ngValue]="4">4</option>
                <option [ngValue]="5">5</option>
                <option [ngValue]="6">6</option>
                <option [ngValue]="7">7</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label mb-1">Loại câu hỏi</label>
            <select class="form-select" [(ngModel)]="pendingFilters.type" (click)="$event.stopPropagation()"
              [disabled]="isLoading">
              <option value="">Tất cả</option>
              <option value="MULTIPLE_CHOICE">Trắc nghiệm</option>
              <option value="ESSAY">Tự luận</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label mb-1">Người tạo</label>
            <input type="text" class="form-control" placeholder="Tên / username..."
              [(ngModel)]="pendingFilters.createdBy" (click)="$event.stopPropagation()" [disabled]="isLoading" />
          </div>

          <div class="mb-2">
            <label class="form-label mb-1">Khoảng thời gian</label>
            <div class="row g-2">
              <div class="col-6">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Từ ngày</mat-label>
                  <input matInput [matDatepicker]="fromPicker" placeholder="dd-MM-yyyy"
                    [(ngModel)]="pendingFilters.from" (click)="$event.stopPropagation()" [disabled]="isLoading" />
                  <mat-datepicker-toggle matSuffix [for]="fromPicker"
                    (click)="$event.stopPropagation()"></mat-datepicker-toggle>
                  <mat-datepicker #fromPicker (closed)="onDatepickerClosed($event)"></mat-datepicker>
                </mat-form-field>
              </div>
              <div class="col-6">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Đến ngày</mat-label>
                  <input matInput [matDatepicker]="toPicker" placeholder="dd-MM-yyyy" [(ngModel)]="pendingFilters.to"
                    (click)="$event.stopPropagation()" [disabled]="isLoading" />
                  <mat-datepicker-toggle matSuffix [for]="toPicker"
                    (click)="$event.stopPropagation()"></mat-datepicker-toggle>
                  <mat-datepicker #toPicker (closed)="onDatepickerClosed($event)"></mat-datepicker>
                </mat-form-field>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between mt-3 gap-2">
            <button class="btn btn-outline-secondary" (click)="resetPendingFilters(); $event.stopPropagation()"
              [disabled]="isLoading">
              <i class="bi bi-x-circle"></i> Xóa bộ lọc
            </button>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary" (click)="cancelPendingChanges(); closeDropdown(filterDropdown)"
                [disabled]="isLoading">Hủy</button>
              <button class="btn btn-primary" (click)="applyPendingFiltersAndClose(filterDropdown)"
                [disabled]="isLoading">Áp dụng</button>
            </div>
          </div>

          <div *ngIf="hasPendingChanges()" class="mt-2 p-2 bg-light rounded small">
            <div class="text-muted mb-1">Thay đổi chưa áp dụng:</div>
            <div class="text-truncate">{{ getPendingChangesSummary() }}</div>
          </div>
        </div>
      </div>

      <!-- Chọn tất cả (dropdown) -->
      <div class="dropdown ms-auto">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
          data-bs-auto-close="true" [disabled]="isLoading">
          Chọn tất cả
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <button class="dropdown-item p-2" (click)="onSelectAllScope('page','main')" [disabled]="isLoading">
              {{ areAllMainsOnPageSelected() ? 'Bỏ chọn trang (bản chính)' : 'Chọn trang này (bản chính)' }}
            </button>
          </li>
          <li>
            <button class="dropdown-item p-2" (click)="onSelectAllScope('list','main')" [disabled]="isLoading">
              {{ isAllMainsListSelected() ? 'Bỏ chọn danh sách (bản chính)' : 'Chọn danh sách (bản chính)' }}
            </button>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <li>
            <button class="dropdown-item p-2" (click)="onSelectAllScope('page','clone')" [disabled]="isLoading">
              {{ areAllClonesOnPageSelected() ? 'Bỏ chọn trang (bản sao)' : 'Chọn trang này (bản sao)' }}
            </button>
          </li>
          <li>
            <button class="dropdown-item p-2" (click)="onSelectAllScope('list','clone')" [disabled]="isLoading">
              {{ isAllClonesListSelected() ? 'Bỏ chọn danh sách (bản sao)' : 'Chọn danh sách (bản sao)' }}
            </button>
          </li>
        </ul>
      </div>
    </div>

    <!-- Tóm tắt filter -->
    <div *ngIf="activeFilterSummaryParts.length" class="filter-summary mt-2">
      <span class="me-2 fw-semibold">Đang lọc:</span>
      <span class="chips">{{ activeFilterSummaryParts.join(' • ') }}</span>
      <button class="btn btn-sm btn-link ms-2 p-0" (click)="clearAllFilters()">
        <span class="text-danger fw-bold">×</span> Xóa hết lọc
      </button>
    </div>

    <!-- Hàng nút phụ -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div>
        <mat-slide-toggle [(ngModel)]="showAnswers" color="primary" (change)="checkAuthorization()"
          [disabled]="isLoading">
          {{ showAnswers ? 'Ẩn đáp án' : 'Hiện đáp án' }}
        </mat-slide-toggle>
      </div>
      <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-outline-secondary" (click)="openImportDryRun()" [disabled]="isLoading" *ngIf="isAdminOrHead || labelFilter === 'PRACTICE'">
          <i class="bi bi-upload me-1"></i> Tải câu hỏi lên
        </button>
        <button class="btn btn-outline-secondary" (click)="openAutoGenDialog()" [disabled]="isLoading">
          <i class="bi bi-magic me-1"></i> Sinh đề tự động
        </button>
        <button class="btn btn-primary" (click)="openCreateQuestionDialog()" [disabled]="isLoading" *ngIf="isAdminOrHead || labelFilter === 'PRACTICE'"><i
            class="bi bi-plus-circle me-1"></i> Thêm Câu hỏi</button>
      </div>
    </div>

    <!-- Bulk action bar -->
    <div *ngIf="selectedCount > 0" class="alert alert-info d-flex justify-content-between align-items-center mt-3">
      <div><b>{{ selectedCount }}</b> câu hỏi đã chọn</div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-success" (click)="exportSelected()" [disabled]="isLoading"><i
            class="bi bi-download"></i> Xuất file</button>
        <button class="btn btn-sm btn-outline-danger" (click)="deleteSelected()" [disabled]="isLoading" *ngIf="isAdminOrHead || labelFilter === 'PRACTICE'"><i
            class="bi bi-trash"></i> Xóa</button>
        <button class="btn btn-sm btn-outline-danger" (click)="clearSelection()" [disabled]="isLoading"><i
            class="bi bi-x-lg"></i> Bỏ chọn</button>
      </div>
    </div>

  </div>
</div>

<!-- Empty state -->
<div *ngIf="!isLoading && paginatedQuestions.length === 0" class="text-center py-5">
  <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
  <h4 class="mt-3">Chưa có câu hỏi nào</h4>
  <p class="text-muted">Hãy thêm câu hỏi mới cho môn học này</p>
</div>

<!-- Danh sách câu hỏi + clones -->
<div *ngIf="!isLoading && paginatedQuestions.length > 0" class="row row-cols-1 g-4">
    <mat-paginator [length]="totalItems" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" [pageIndex]="currentPage"
    (page)="onPageChange($event)" showFirstLastButtons [disabled]="isLoading">
  </mat-paginator>
  
  <div class="col" *ngFor="let question of paginatedQuestions; trackBy: trackById">
    <div class="card h-100 shadow-sm item-card" [class.selected]="isSelected(question.id)"
      [class.selectedFlag]="question.flagged" (click)="onCardClick($event, question.id)">
      <div class="card-body position-relative">
        <div class="d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input mt-0 item-checkbox" [checked]="isSelected(question.id)"
            (change)="onItemSelectChange($event, question.id)" (click)="$event.stopPropagation()"
            [disabled]="isLoading" />
          <h5 class="card-title m-0">Câu hỏi {{ getCode(question) }}</h5>
          <span *ngIf="question.flagged" class="badge rounded-pill text-bg-warning ms-2">Đã báo lỗi</span>
          <span *ngIf="question.labels?.includes('PRACTICE')" class="badge rounded-pill text-bg-info ms-2">Ôn tập</span>
          <span *ngIf="question.labels?.includes('EXAM')" class="badge rounded-pill text-bg-warning ms-1">Thi cử</span>
        </div>

        <div class="kv-row mt-2">
          <div class="kv-label">Nội dung:</div>
          <div class="kv-value math-inline" [appMathjax]="question.content || ''"></div>
        </div>

        <div class="position-absolute top-0 end-0 mt-2 me-2 text-muted small text-end">
          <p class="mb-0"><strong>Chương:</strong> {{ question.chapter }}</p>
          <p class="mb-0"><strong>Độ khó:</strong> {{ question.difficulty }}</p>
        </div>

        <p *ngIf="question.imageUrl" class="card-text">
          <strong>Hình ảnh:</strong><br />
          <img [src]="question.imageUrl" alt="Question Image" class="img-fluid" style="max-height: 200px;" />
        </p>

        <!-- Trắc nghiệm -->
        <div *ngIf="question.questionType === 'MULTIPLE_CHOICE'" class="row g-3 mt-1">
          <div class="col-6">
            <div class="kv-row">
              <div class="kv-label">A:</div>
              <div class="kv-value math-inline" [appMathjax]="question.optionA || ''"></div>
            </div>
            <div class="kv-row mt-1">
              <div class="kv-label">B:</div>
              <div class="kv-value math-inline" [appMathjax]="question.optionB || ''"></div>
            </div>
          </div>
          <div class="col-6">
            <div class="kv-row">
              <div class="kv-label">C:</div>
              <div class="kv-value math-inline" [appMathjax]="question.optionC || ''"></div>
            </div>
            <div class="kv-row mt-1">
              <div class="kv-label">D:</div>
              <div class="kv-value math-inline" [appMathjax]="question.optionD || ''"></div>
            </div>
          </div>
        </div>

        <p *ngIf="showAnswers && question.answer" class="card-text"><strong>Đáp án:</strong> {{ question.answer }}</p>
        <div *ngIf="showAnswers && question.answerText" class="kv-row mt-2">
          <div class="kv-label">Giải thích:</div>
          <div class="kv-value math-inline" [appMathjax]="question.answerText || ''"></div>
        </div>
      </div>

      <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center text-muted small">
          <div class="d-flex align-items-center gap-2">
            <span><strong>Người tạo:</strong> {{ question.createdBy?.fullName || question.createdBy?.username || '--'
              }}</span>
            <span class="ms-2"><strong>Ngày tạo:</strong> {{ question.createdAt | date:'short' }}</span>
          </div>

          <div class="btn-group">
            <!-- NEW: Báo lỗi / Gỡ lỗi -->
            <button *ngIf="!question.flagged" class="btn btn-sm btn-outline-warning me-2"
              (click)="openFlagPrompt(question)" [disabled]="isLoading">
              <i class="bi bi-flag"></i> Báo lỗi
            </button>
            <button *ngIf="question.flagged" class="btn btn-sm btn-warning me-2" (click)="unflagQuestion(question)"
              [disabled]="isLoading">
              <i class="bi bi-flag-fill"></i> Gỡ lỗi
            </button>

            <!-- giữ nguyên các nút còn lại -->
            <button class="btn btn-sm btn-outline-secondary me-2" (click)="openClonePrompt(question)"
              [disabled]="isLoading">
              <i class="bi bi-layers"></i> Nhân bản
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" (click)="toggleClones(question)"
              [disabled]="isLoading">
              <i class="bi" [ngClass]="stateOf(question.id).open ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
              Bản sao
              <span *ngIf="stateOf(question.id).items.length > 0" class="badge rounded-pill text-bg-secondary ms-1">
                {{ stateOf(question.id).items.length }}
              </span>
            </button>
            <button class="btn btn-sm btn-outline-primary me-2" (click)="openEditQuestionDialog(question)"
              [disabled]="isLoading" *ngIf="isAdminOrHead || labelFilter === 'PRACTICE'">
              <i class="bi bi-pencil"></i> Sửa
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="deleteQuestion(question.id)" [disabled]="isLoading" *ngIf="isAdminOrHead || labelFilter === 'PRACTICE'">
              <i class="bi bi-trash"></i> Xóa
            </button>
          </div>


          <!-- Clones -->
          <div *ngIf="stateOf(question.id).open" class="mt-3">
            <div *ngIf="stateOf(question.id).loading" class="text-muted small">
              <i class="bi bi-hourglass-split"></i> Đang tải bản sao...
            </div>
            <div *ngIf="!stateOf(question.id).loading && stateOf(question.id).items.length === 0"
              class="text-muted small">
              <i class="bi bi-inboxes"></i> Chưa có bản sao.
            </div>
            <div class="row row-cols-1 g-3"
              *ngIf="!stateOf(question.id).loading && stateOf(question.id).items.length > 0">
              <div class="col" *ngFor="let c of stateOf(question.id).items">
                <div class="card border-0 shadow-sm clone-card position-relative"
                  [class.selected-border]="isCloneSelected(c.id)" (click)="onCloneCardClick($event, c)">
                  <div class="card-body position-relative">
                    <div class="d-flex align-items-center gap-2">
                      <input type="checkbox" class="form-check-input mt-0 item-checkbox"
                        [checked]="isCloneSelected(c.id)" (change)="onCloneSelectChange($event, c)"
                        (click)="$event.stopPropagation()" [disabled]="isLoading" />
                      <h6 class="card-title m-0">Bản sao {{ getCloneCode(question, c) }}</h6>

                      <span *ngIf="c.labels?.includes('PRACTICE')" class="badge rounded-pill text-bg-info ms-2">Ôn
                        tập</span>
                      <span *ngIf="c.labels?.includes('EXAM')" class="badge rounded-pill text-bg-warning ms-1">Thi
                        cử</span>
                    </div>

                    <div class="position-absolute top-0 end-0 mt-2 me-2 text-muted small text-end">
                      <p class="mb-0"><strong>Chương:</strong> {{ c.chapter }}</p>
                      <p class="mb-0"><strong>Độ khó:</strong> {{ c.difficulty }}</p>
                    </div>

                    <div class="mt-2">
                      <div class="kv-row mt-2">
                        <div class="kv-label">Nội dung:</div>
                        <div class="kv-value math-inline" [appMathjax]="c.content || ''"></div>
                      </div>

                      <div *ngIf="c.questionType === 'MULTIPLE_CHOICE'" class="row g-3 mt-1">
                        <div class="col-6">
                          <div class="kv-row">
                            <div class="kv-label">A:</div>
                            <div class="kv-value math-inline" [appMathjax]="c.optionA || ''"></div>
                          </div>
                          <div class="kv-row mt-1">
                            <div class="kv-label">B:</div>
                            <div class="kv-value math-inline" [appMathjax]="c.optionB || ''"></div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="kv-row">
                            <div class="kv-label">C:</div>
                            <div class="kv-value math-inline" [appMathjax]="c.optionC || ''"></div>
                          </div>
                          <div class="kv-row mt-1">
                            <div class="kv-label">D:</div>
                            <div class="kv-value math-inline" [appMathjax]="c.optionD || ''"></div>
                          </div>
                        </div>
                      </div>

                      <div *ngIf="showAnswers && c.answer" class="card-text mt-1"><strong>Đáp án:</strong> {{ c.answer
                        }}
                      </div>
                      <div *ngIf="showAnswers && c.answerText" class="kv-row mt-2">
                        <div class="kv-label">Giải thích:</div>
                        <div class="kv-value math-inline" [appMathjax]="c.answerText || ''"></div>
                      </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-2">
                      <button class="btn btn-outline-primary btn-sm" (click)="openEditCloneDialog(c)"
                        [disabled]="isLoading">
                        <i class="bi bi-pencil"></i> Sửa
                      </button>
                      <button class="btn btn-outline-danger btn-sm" (click)="deleteClone(c)" [disabled]="isLoading">
                        <i class="bi bi-trash"></i> Xóa
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div> <!-- /row clones -->
          </div> <!-- /clones -->
        </div>
      </div>
    </div>
  </div>

  <!-- Paginator (server-side) -->
  <mat-paginator [length]="totalItems" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" [pageIndex]="currentPage"
    (page)="onPageChange($event)" showFirstLastButtons [disabled]="isLoading">
  </mat-paginator>
</div>
<!-- Overlay loading -->
<app-loading-screen *ngIf="isLoading" [title]="loadingTitle" [subtitle]="loadingSubtitle"
  [showProgressBar]="showProgressBar" [progress]="progress" [blurBackground]="true" (action)="reloadPage()">
  <div class="footer small text-muted">Đang xử lý… xin vui lòng đợi.</div>
</app-loading-screen>