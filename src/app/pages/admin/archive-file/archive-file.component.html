<!-- src/app/pages/admin/archive-file/archive-file.component.html -->
<div class="container mt-4">
  <div class="card shadow-sm mb-3">
    <div class="card-body">

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-outline-secondary btn-sm" (click)="toggleFilters()">
          <i class="bi bi-funnel me-1"></i> Bộ lọc
        </button>

        <div class="flex-grow-1 col-6">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control border-start-0" placeholder="Tìm theo tên file…"
              [formControl]="search">
          </div>
        </div>

        <button *ngIf="isPendingTab" class="btn btn-outline-primary btn-sm ms-auto" (click)="resetSnooze()"
          matTooltip="Bật lại thông báo đã bị tạm ẩn">
          <i class="bi bi-bell"></i> Bật thông báo
        </button>
      </div>

      <!-- Khối bộ lọc mở rộng: dùng chung cho All/Imports/Exports/Pending -->
      <div *ngIf="showFilters" class="mt-3">
        <div class="row g-2 align-items-end">
          <!-- <div class="col-12 col-md-2 col-lg-1">
            <label class="form-label mb-1">Trạng thái</label>
            <select class="form-select form-select-sm" [formControl]="statusSel">
              <option value="">Tất cả</option>
              <option value="PENDING">Pending</option>
              <option value="APPROVED">Approved</option>
              <option value="REJECTED">Rejected</option>
            </select>
          </div> -->

          <div class="col-12 col-md-4 col-lg-3">
            <label class="form-label mb-1">Môn học (tên / mã)</label>
            <input class="form-control form-control-sm" [formControl]="filterSubjectText"
              placeholder="VD: CS101 hoặc Data Structures">
          </div>

          <div class="col-12 col-md-2 col-lg-3">
            <label class="form-label mb-1">Người tạo (username / họ tên)</label>
            <input class="form-control form-control-sm" [formControl]="filterUploaderText"
              placeholder="vd: huy0305 hoặc Nguyen Huy">
          </div>

          <div class="col-6 col-md-2 col-lg-2">
            <label class="form-label mb-1 d-block">Từ ngày</label>
            <mat-form-field appearance="outline" class="w-100 compact-mat" subscriptSizing="dynamic">
              <input matInput [matDatepicker]="fromPicker" [formControl]="filterFrom">
              <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
              <mat-datepicker #fromPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="col-6 col-md-2 col-lg-2">
            <label class="form-label mb-1 d-block">Đến ngày</label>
            <mat-form-field appearance="outline" class="w-100 compact-mat" subscriptSizing="dynamic">
              <input matInput [matDatepicker]="toPicker" [formControl]="filterTo">
              <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
              <mat-datepicker #toPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="col-12 d-flex justify-content-end gap-2 mt-2">
            <button class="btn btn-sm btn-outline-secondary" (click)="clearClientFilters()">
              <i class="bi bi-x-circle"></i> Xoá bộ lọc
            </button>
            <button class="btn btn-sm btn-primary" (click)="applyFilters()">Áp dụng</button>
          </div>
        </div>
      </div>

    </div>

    <!-- Tabs ngoài chỉ khi không bị ép kind và không ở moderation
  <mat-tab-group *ngIf="showOuterTabs" (selectedIndexChange)="onOuterTabChange($event)">
    <mat-tab label="All"></mat-tab>
    <mat-tab label="Imports"></mat-tab>
    <mat-tab label="Exports"></mat-tab>
  </mat-tab-group> -->

    <!-- Tabs con cho EXPORT: ẨN khi moderation hoặc có reviewStatusFilter (Pending/History) -->
    <div *ngIf="finalKind === 'EXPORT' && !moderationMode && !reviewStatusFilter" class="mt-3">
      <mat-tab-group (selectedIndexChange)="onExportTabChange($event)">
        <mat-tab label="Practice"></mat-tab>
        <mat-tab label="Exam"></mat-tab>
      </mat-tab-group>
    </div>

    <div class="position-relative mt-3">
      <div *ngIf="loading" class="loading-overlay">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <div class="table-responsive border rounded">
        <table mat-table [dataSource]="viewRows" class="mat-elevation-z0 mb-0">

          <!-- Filename -->
          <ng-container matColumnDef="filename">
            <th mat-header-cell *matHeaderCellDef>Tên file</th>
            <td mat-cell *matCellDef="let r">
              <div class="d-flex align-items-center gap-2">
                <i [class]="iconClass(r)" aria-hidden="true"></i>
                <span class="fw-semibold">{{ r.filename }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Subject -->
          <ng-container matColumnDef="subject">
            <th mat-header-cell *matHeaderCellDef>Môn học</th>
            <td mat-cell *matCellDef="let r">{{ r.subjectName || ('#' + r.subjectId) }}</td>
          </ng-container>

          <!-- Uploader -->
          <ng-container matColumnDef="uploader">
            <th mat-header-cell *matHeaderCellDef>Người tạo</th>
            <td mat-cell *matCellDef="let r">{{ r.uploaderName || ('User #' + r.userId) }}</td>
          </ng-container>

          <!-- Size -->
          <ng-container matColumnDef="size">
            <th mat-header-cell *matHeaderCellDef>Kích thước</th>
            <td mat-cell *matCellDef="let r">{{ humanSize(r.sizeBytes) }}</td>
          </ng-container>

          <!-- Kind -->
          <ng-container matColumnDef="kind">
            <th mat-header-cell *matHeaderCellDef>Loại</th>
            <td mat-cell *matCellDef="let r">
              <span [class]="badgeClass(r.kind)">{{ r.kind }}</span>
            </td>
          </ng-container>

          <!-- Variant -->
          <ng-container matColumnDef="variant">
            <th mat-header-cell *matHeaderCellDef>Loại đề</th>
            <td mat-cell *matCellDef="let r">
              <span *ngIf="r.kind === 'EXPORT'; else dash" [class]="variantBadge(r)">
                {{ (r.variant || '—') | titlecase }}
              </span>
              <ng-template #dash>—</ng-template>
            </td>
          </ng-container>

          <!-- Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Trạng thái</th>
            <td mat-cell *matCellDef="let r">
              <span [class]="statusBadge(r.reviewStatus)" [matTooltip]="rejectTooltip(r)">
                {{ (r.reviewStatus || '—') | titlecase }}
              </span>
            </td>
          </ng-container>

          <!-- CreatedAt -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Thời gian</th>
            <td mat-cell *matCellDef="let r">{{ r.createdAt | date:'dd/MM/yyyy, HH:mm' }}</td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-end col-actions">Thao tác</th>
            <td mat-cell *matCellDef="let r" class="text-end col-actions">
              <span class="me-2" *ngIf="headStatus.get(r.id) !== undefined">
                <mat-icon [matTooltip]="headStatus.get(r.id) ? 'Có trên GCS' : 'Thiếu trên GCS'"
                  [ngClass]="headStatus.get(r.id) ? 'text-success' : 'text-danger'">
                  {{ headStatus.get(r.id) ? 'cloud_done' : 'cloud_off' }}
                </mat-icon>
              </span>

              <!-- Moderation: View / Approve / Reject -->
              <ng-container *ngIf="moderationMode; else normalActions">
                <button mat-button color="primary" (click)="view(r)" matTooltip="Xem nhanh">
                  <mat-icon>open_in_new</mat-icon> View
                </button>
                <button mat-button color="accent" (click)="approveFile(r)"
                  [disabled]="(r.reviewStatus || '').toUpperCase() !== 'PENDING'">
                  <mat-icon>check_circle</mat-icon> Approve
                </button>
                <button mat-button color="warn" (click)="rejectFile(r)"
                  [disabled]="(r.reviewStatus || '').toUpperCase() !== 'PENDING'">
                  <mat-icon>cancel</mat-icon> Reject
                </button>
              </ng-container>

              <!-- Normal: View / Download / Delete (không có nút "Info" nữa) -->
              <ng-template #normalActions>
                <span class="actions-wrap">
                  <button mat-button color="primary" (click)="view(r)">
                    <mat-icon>open_in_new</mat-icon> View
                  </button>

                  <button *ngIf="(r.reviewStatus || '').toUpperCase() === 'APPROVED'" mat-button color="accent"
                    (click)="download(r)">
                    <mat-icon>download</mat-icon> Download
                  </button>

                  <button mat-button color="warn" (click)="confirmDelete(r)">
                    <mat-icon>delete</mat-icon> Delete
                  </button>
                </span>
              </ng-template>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <tr *ngIf="!loading && viewRows.length === 0">
            <td [attr.colspan]="displayedColumns.length" class="text-center py-4 text-muted">
              Không có file nào.
            </td>
          </tr>
        </table>
      </div>

      <mat-paginator [length]="total" [pageIndex]="pageIndex" [pageSize]="pageSize" [pageSizeOptions]="[10, 20, 50]"
        (page)="onPage($event)" class="mt-2">
      </mat-paginator>
    </div>
  </div>