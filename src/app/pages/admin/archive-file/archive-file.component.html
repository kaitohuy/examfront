<!-- src/app/pages/admin/archive-file/archive-file.component.html -->
<div class="container mt-4">
  <div class="card shadow-sm mb-3">
    <div class="card-body">

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-outline-secondary btn-sm" (click)="toggleFilters()" [disabled]="isLoading">
          <i class="bi bi-funnel me-1"></i> Bộ lọc
        </button>
        <div class="flex-grow-1 col-6">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control border-start-0" placeholder="Tìm theo tên file…"
              [formControl]="search">
          </div>
        </div>

        <button *ngIf="isPendingTab" class="btn btn-outline-primary btn-sm ms-auto" (click)="resetSnooze()"
          [disabled]="isLoading" matTooltip="Bật lại thông báo đã bị tạm ẩn">
          <i class="bi bi-bell"></i> Bật thông báo
        </button>
      </div>

      <!-- Khối bộ lọc mở rộng: dùng chung cho All/Imports/Exports/Pending -->
      <div *ngIf="showFilters" class="mt-3">
        <div class="row g-2 align-items-end">
          <!-- <div class="col-12 col-md-2 col-lg-1">
            <label class="form-label mb-1">Trạng thái</label>
            <select class="form-select form-select-sm" [formControl]="statusSel">
              <option value="">Tất cả</option>
              <option value="PENDING">Pending</option>
              <option value="APPROVED">Approved</option>
              <option value="REJECTED">Rejected</option>
            </select>
          </div> -->

          <div class="col-12 col-md-4 col-lg-3">
            <label class="form-label mb-1">Môn học (tên / mã)</label>
            <input class="form-control form-control-sm" [formControl]="filterSubjectText"
              placeholder="VD: CS101 hoặc Data Structures">
          </div>

          <div class="col-12 col-md-2 col-lg-3">
            <label class="form-label mb-1">Người tạo (username / họ tên)</label>
            <input class="form-control form-control-sm" [formControl]="filterUploaderText"
              placeholder="vd: huy0305 hoặc Nguyen Huy">
          </div>

          <div class="col-6 col-md-2 col-lg-2">
            <label class="form-label mb-1 d-block">Từ ngày</label>
            <mat-form-field appearance="outline" class="w-100 compact-mat" subscriptSizing="dynamic">
              <input matInput [matDatepicker]="fromPicker" [formControl]="filterFrom">
              <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
              <mat-datepicker #fromPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="col-6 col-md-2 col-lg-2">
            <label class="form-label mb-1 d-block">Đến ngày</label>
            <mat-form-field appearance="outline" class="w-100 compact-mat" subscriptSizing="dynamic">
              <input matInput [matDatepicker]="toPicker" [formControl]="filterTo">
              <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
              <mat-datepicker #toPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="col-12 d-flex justify-content-end gap-2 mt-2">
            <button class="btn btn-sm btn-outline-secondary" (click)="clearClientFilters()">
              <i class="bi bi-x-circle"></i> Xoá bộ lọc
            </button>
            <button class="btn btn-sm btn-primary" (click)="applyFilters()">Áp dụng</button>
          </div>
        </div>
      </div>

    </div>

    <!-- Tabs con cho EXPORT: ẨN khi moderation hoặc có reviewStatusFilter (Pending/History) -->
    <div *ngIf="finalKind === 'EXPORT' && !moderationMode && !reviewStatusFilter && !forceVariant" class="mt-3">
      <mat-tab-group (selectedIndexChange)="onExportTabChange($event)">
        <mat-tab label="Practice"></mat-tab>
        <mat-tab label="Exam"></mat-tab>
      </mat-tab-group>
    </div>

    <div class="position-relative mt-3">
      <div *ngIf="isAnswerTab && canUploadAnswer()" class="mb-2 text-end">
        <button mat-flat-button color="primary" (click)="openUploadAnswerDialog()" [disabled]="isLoading">
          <mat-icon>upload</mat-icon>
          <span class="ms-1">Upload file đáp án</span>
        </button>
      </div>
      <div class="table-responsive border rounded">
        <table mat-table [dataSource]="viewRows" class="mat-elevation-z0 mb-0">

          <!-- Filename -->
          <ng-container matColumnDef="filename">
            <th mat-header-cell *matHeaderCellDef>Tên file</th>
            <td mat-cell *matCellDef="let r">
              <div class="d-flex align-items-center gap-2">
                <i [class]="iconClass(r)" aria-hidden="true"></i>
                <span class="fw-semibold">{{ r.filename }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Subject -->
          <ng-container matColumnDef="subject">
            <th mat-header-cell *matHeaderCellDef>Môn học</th>
            <td mat-cell *matCellDef="let r">{{ r.subjectName || ('#' + r.subjectId) }}</td>
          </ng-container>

          <!-- Uploader -->
          <ng-container matColumnDef="uploader">
            <th mat-header-cell *matHeaderCellDef>Người tạo</th>
            <td mat-cell *matCellDef="let r">{{ r.uploaderName || ('User #' + r.userId) }}</td>
          </ng-container>

          <!-- Size -->
          <ng-container matColumnDef="size">
            <th mat-header-cell *matHeaderCellDef>Kích thước</th>
            <td mat-cell *matCellDef="let r">{{ humanSize(r.sizeBytes) }}</td>
          </ng-container>

          <!-- Kind -->
          <ng-container matColumnDef="kind">
            <th mat-header-cell *matHeaderCellDef>Loại</th>
            <td mat-cell *matCellDef="let r">
              <span [class]="badgeClass(r.kind)">{{ r.kind }}</span>
            </td>
          </ng-container>

          <!-- Variant -->
          <ng-container matColumnDef="variant">
            <th mat-header-cell *matHeaderCellDef>Loại đề</th>
            <td mat-cell *matCellDef="let r">
              <ng-container [ngSwitch]="(r.kind || '').toUpperCase()">
                <!-- EXPORT: hiển thị PRACTICE/EXAM như cũ -->
                <span *ngSwitchCase="'EXPORT'" [class]="variantBadge(r)">
                  {{ (r.variant || '—') | titlecase }}
                </span>

                <span *ngSwitchCase="'SUBMISSION'" [class]="variantBadge(r)">
                  {{ (r.variant || '—') | titlecase }}
                </span>

                <!-- Mặc định (IMPORT/khác): dấu gạch -->
                <span *ngSwitchDefault>—</span>
              </ng-container>
            </td>
          </ng-container>

          <!-- Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Trạng thái</th>
            <td mat-cell *matCellDef="let r">
              <span [class]="statusBadge(r.reviewStatus)" [matTooltip]="rejectTooltip(r)">
                {{ (r.reviewStatus || '—') | titlecase }}
              </span>
            </td>
          </ng-container>

          <!-- CreatedAt -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Thời gian</th>
            <td mat-cell *matCellDef="let r">{{ r.createdAt | date:'dd/MM/yyyy, HH:mm' }}</td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-center col-actions">Thao tác</th>
            <td mat-cell *matCellDef="let r" class="col-actions justify-content-between align-items-center">
              <span *ngIf="headStatus.get(r.id) !== undefined">
                <mat-icon [matTooltip]="headStatus.get(r.id) ? 'Có trên GCS' : 'Thiếu trên GCS'"
                  [ngClass]="headStatus.get(r.id) ? 'text-success' : 'text-danger'">
                  {{ headStatus.get(r.id) ? 'cloud_done' : 'cloud_off' }}
                </mat-icon>
              </span>

              <!-- ========== MODERATION MODE ========== -->
              <ng-container *ngIf="moderationMode">
                <button mat-button color="primary" (click)="view(r)" matTooltip="Xem nhanh">
                  <mat-icon>open_in_new</mat-icon> Xem
                </button>
                <button mat-button color="accent" (click)="approveFile(r)"
                  [disabled]="isLoading || ((r.reviewStatus || '').toUpperCase() !== 'PENDING')">
                  <mat-icon>check_circle</mat-icon> Duyệt
                </button>
                <button mat-button color="warn" (click)="rejectFile(r)"
                  [disabled]="isLoading || ((r.reviewStatus || '').toUpperCase() !== 'PENDING')">
                  <mat-icon>cancel</mat-icon> Hủy
                </button>
              </ng-container>

              <!-- ========== NORMAL MODE ========== -->
              <ng-container *ngIf="!moderationMode">

                <!-- FILE SUBMISSION: Dropdown menu với icon settings -->
                <ng-container *ngIf="isSubmissionRow(r)">
                  <button mat-icon-button [matMenuTriggerFor]="submissionMenu" [disabled]="isLoading"
                    matTooltip="Thao tác">
                    <mat-icon>settings</mat-icon>
                  </button>

                  <mat-menu #submissionMenu="matMenu">
                    <button mat-menu-item (click)="view(r)">
                      <mat-icon>open_in_new</mat-icon>
                      <span>Xem</span>
                    </button>

                    <button mat-menu-item (click)="download(r)"
                      *ngIf="(r.reviewStatus || '').toUpperCase() === 'APPROVED'" [disabled]="isLoading">
                      <mat-icon>download</mat-icon>
                      <span>Tải về</span>
                    </button>

                    <mat-divider *ngIf="canRegenerateAnswer(r)"></mat-divider>

                    <button mat-menu-item (click)="regenerateAnswerFromSubmission(r)" *ngIf="canRegenerateAnswer(r)"
                      [disabled]="isLoading">
                      <mat-icon color="accent">auto_awesome</mat-icon>
                      <span>Sinh đáp án</span>
                    </button>

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="confirmDelete(r)" [disabled]="isLoading" class="text-danger">
                      <mat-icon>delete</mat-icon>
                      <span>Xóa</span>
                    </button>
                  </mat-menu>
                </ng-container>

                <!-- FILE ĐÁP ÁN (ANSWER): Dropdown menu với icon settings + lock status -->
                <ng-container *ngIf="isAnswerRow(r)">

                  <button mat-icon-button [matMenuTriggerFor]="answerMenu" [disabled]="isLoading" matTooltip="Thao tác">
                    <mat-icon>settings</mat-icon>
                  </button>

                  <!-- Icon lock/unlock status -->
                  <mat-icon *ngIf="locked(r)" class="text-warning me-2" matTooltip="Chưa đến giờ mở đáp án">
                    lock
                  </mat-icon>
                  <mat-icon *ngIf="!locked(r) && hasReleaseAt(r)" class="text-success me-2"
                    matTooltip="Đã đến giờ mở đáp án">
                    lock_open
                  </mat-icon>
                  
                  <mat-menu #answerMenu="matMenu">
                    <button mat-menu-item (click)="view(r)" [disabled]="isLoading || locked(r)">
                      <mat-icon>open_in_new</mat-icon>
                      <span>Xem</span>
                    </button>

                    <button mat-menu-item (click)="download(r)"
                      *ngIf="(r.reviewStatus || '').toUpperCase() === 'APPROVED'" [disabled]="isLoading || locked(r)">
                      <mat-icon>download</mat-icon>
                      <span>Tải về</span>
                    </button>

                    <mat-divider *ngIf="canScheduleAnswer(r)"></mat-divider>

                    <button mat-menu-item (click)="openReleaseAt(r)" *ngIf="canScheduleAnswer(r)"
                      [disabled]="isLoading">
                      <mat-icon color="accent">schedule</mat-icon>
                      <span>Lịch mở</span>
                    </button>

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="confirmDelete(r)" [disabled]="isLoading" class="text-danger">
                      <mat-icon>delete</mat-icon>
                      <span>Xóa</span>
                    </button>
                  </mat-menu>
                </ng-container>

                <!-- CÁC FILE KHÁC (PRACTICE, EXAM, IMPORT): Giữ nguyên buttons -->
                <span class="actions-wrap" *ngIf="!isSubmissionRow(r) && !isAnswerRow(r)">
                  <button mat-button color="primary" (click)="view(r)" [disabled]="isLoading">
                    <mat-icon>open_in_new</mat-icon> Xem
                  </button>

                  <button *ngIf="(r.reviewStatus || '').toUpperCase() === 'APPROVED'" mat-button color="accent"
                    (click)="download(r)" [disabled]="isLoading">
                    <mat-icon>download</mat-icon> Tải về
                  </button>

                  <button mat-button color="warn" (click)="confirmDelete(r)" [disabled]="isLoading">
                    <mat-icon>delete</mat-icon> Xóa
                  </button>
                </span>
              </ng-container>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell text-center py-4 text-muted" [attr.colspan]="displayedColumns.length">
              {{ emptyMessage }}
            </td>
          </tr>
        </table>
      </div>

      <mat-paginator [length]="total" [pageIndex]="pageIndex" [pageSize]="pageSize" [pageSizeOptions]="[10, 20, 50]"
        (page)="onPage($event)" class="mt-2">
      </mat-paginator>
    </div>
  </div>

  <app-loading-screen *ngIf="isLoading"></app-loading-screen>