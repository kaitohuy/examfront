<mat-card class="ep-card" [attr.aria-busy]="isLoading">
  <div class="ep-header">
    <div>
      <h2>Thêm người dùng</h2>
      <div class="subtitle">Tạo tài khoản, gán quyền & phân công giảng dạy</div>
    </div>
    <img src="assets/images/ptit.png" class="logo" alt="logo" />
  </div>

  <mat-divider />

  <form [formGroup]="form" (ngSubmit)="submit()" class="ep-grid" autocomplete="off">
    <!-- 1. THÔNG TIN CÁ NHÂN -->
    <div class="section col-span-full">
      <div class="section-title">Thông tin cá nhân</div>
    </div>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Họ *</mat-label>
      <input matInput formControlName="lastName" autocomplete="off" />
      <mat-error *ngIf="form.controls.lastName.hasError('required')">Bắt buộc</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Tên *</mat-label>
      <input matInput formControlName="firstName" autocomplete="off" />
      <mat-error *ngIf="form.controls.firstName.hasError('required')">Bắt buộc</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-6">
      <mat-label>Email</mat-label>
      <input matInput formControlName="email" autocomplete="off" />
      <mat-error *ngIf="form.controls.email.hasError('email')">Email không hợp lệ</mat-error>
    </mat-form-field>

    <!-- 2. TÀI KHOẢN -->
    <div class="section col-span-full">
      <div class="section-title">Tài khoản</div>
    </div>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Tài khoản *</mat-label>
      <input matInput formControlName="username" autocomplete="off" />
      <mat-hint>Được gợi ý tự động từ tên</mat-hint>
      <mat-error *ngIf="form.controls.username.hasError('required')">Bắt buộc</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Mật khẩu *</mat-label>
      <input matInput [type]="hide ? 'password' : 'text'" formControlName="password"
        [attr.autocomplete]="'new-password'" />
      <button mat-icon-button matSuffix type="button" (click)="hide = !hide" [attr.aria-label]="'Toggle password'">
        <mat-icon>{{ hide ? 'visibility_off' : 'visibility' }}</mat-icon>
      </button>
      <mat-hint>Mặc định sinh tự động</mat-hint>
      <mat-error *ngIf="form.controls.password.hasError('required')">Bắt buộc</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Mã giảng viên *</mat-label>
      <input matInput formControlName="teacherCode" autocomplete="off" />
      <mat-error *ngIf="form.controls.teacherCode.hasError('required')">Bắt buộc</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Điện thoại</mat-label>
      <input matInput formControlName="phone" autocomplete="off" />
      <mat-error *ngIf="form.controls.phone.hasError('pattern')">Số điện thoại không hợp lệ</mat-error>
    </mat-form-field>
    <!-- 3. QUYỀN & PHÂN CÔNG -->
    <div class="section col-span-full">
      <div class="section-title">Quyền & Phân công</div>
    </div>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Vai trò *</mat-label>
      <mat-select formControlName="role">
        <mat-option [value]="null">—</mat-option>
        <mat-option value="ADMIN">ADMIN</mat-option>
        <mat-option value="HEAD">HEAD</mat-option>
        <mat-option value="TEACHER">LECTURER</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-5">
      <mat-label>Bộ môn</mat-label>
      <input matInput [matAutocomplete]="deptAuto" [formControl]="departmentText" placeholder="Gõ để tìm bộ môn…"
        (blur)="syncDeptControlOnBlur()" autocomplete="off" />
      <mat-autocomplete #deptAuto="matAutocomplete" (optionSelected)="selectDepartment($event.option.value)">
        <mat-option *ngFor="let d of filteredDepartments" [value]="d">
          {{ d.name }} — ID: {{ d.id }}
        </mat-option>
      </mat-autocomplete>
      <mat-error *ngIf="form.controls.departmentId.hasError('required')">Hãy chọn Bộ môn cho HEAD</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-4">
      <mat-label>Môn giảng dạy</mat-label>
      <mat-select formControlName="subjectIds" multiple [disabled]="subjectsDisabled()">
        <mat-select-trigger>
          <ng-container *ngIf="subjectIdsSafe().length; else subjPlaceholder">
            {{ subjectsTriggerText() }}
          </ng-container>
          <ng-template #subjPlaceholder>Chọn môn…</ng-template>
        </mat-select-trigger>

        <mat-option disabled>
          <div class="px-1 w-100">
            <mat-form-field appearance="fill" class="w-100 mb-1 subject-search">
              <mat-label>Tìm môn…</mat-label>
              <input matInput [formControl]="subjectFilter" autocomplete="off">
              <button mat-icon-button matSuffix type="button" (click)="subjectFilter.setValue('')">
                <mat-icon>Đóng</mat-icon>
              </button>
            </mat-form-field>
          </div>
        </mat-option>

        <mat-option *ngFor="let s of filteredSubjects" [value]="s.id">
          {{ s.name }} — {{ s.code }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </form>

  <div class="ep-actions">
    <button mat-stroked-button type="button" (click)="cancel()" [disabled]="isLoading">Hủy</button>
    <button mat-flat-button color="primary" [disabled]="form.invalid || isLoading" (click)="submit()">
      {{ isLoading ? 'Đang lưu…' : 'Lưu' }}
    </button>
  </div>
</mat-card>

<!-- Overlay loading mới -->
<app-loading-screen *ngIf="isLoading"></app-loading-screen>