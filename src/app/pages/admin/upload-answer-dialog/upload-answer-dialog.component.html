<h2 mat-dialog-title class="mx-2 my-2">Upload file đáp án</h2>

<mat-dialog-content class="py-3">
    <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle me-2"></i>
        <div>
            <div><strong>Lưu ý:</strong></div>
            <ul class="mb-0 mt-1">
                <li>File đáp án phải là file <strong>ZIP</strong> chứa các file DOCX đáp án</li>
                <li>Thời gian mở đáp án sẽ được HEAD đặt sau</li>
            </ul>
        </div>
    </div>

    <!-- Chọn môn học -->
    <mat-form-field appearance="outline" class="w-100 mb-3">
        <mat-label>Chọn môn học *</mat-label>
        <mat-select [formControl]="subjectControl" [disabled]="loadingSubjects">
            <mat-option>
                <ngx-mat-select-search [formControl]="subjectFilterCtrl" placeholderLabel="Tìm môn học..."
                    noEntriesFoundLabel="Không tìm thấy">
                </ngx-mat-select-search>
                <span class="fw-semibold"> - </span>
            </mat-option>

            <mat-option *ngFor="let s of filteredSubjects" [value]="s.id">
                <div class="d-flex flex-column">
                    <span class="fw-semibold">{{ s.name }}</span>
                    <span class="text-muted small">
                        {{ s.code }}
                        <span *ngIf="s.departmentName"> • {{ s.departmentName }}</span>
                    </span>
                </div>
            </mat-option>
        </mat-select>
        <mat-error *ngIf="subjectControl.hasError('required')">
            Vui lòng chọn môn học
        </mat-error>
        <mat-hint *ngIf="loadingSubjects">Đang tải danh sách môn học...</mat-hint>
    </mat-form-field>

    <!-- File picker -->
    <div class="border rounded p-3 text-center" [class.border-primary]="isDragging" (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">

        <i class="bi bi-cloud-upload fs-1 text-muted d-block mb-2"></i>

        <div *ngIf="!selectedFile" class="mb-2">
            <div class="text-muted">Kéo thả file ZIP vào đây hoặc</div>
            <button mat-stroked-button color="primary" class="mt-2" (click)="fileInput.click()" type="button">
                <mat-icon>attach_file</mat-icon>
                Chọn file
            </button>
        </div>

        <div *ngIf="selectedFile" class="mb-2">
            <div class="d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-file-zip fs-3 text-primary"></i>
                <div>
                    <div class="fw-semibold">{{ selectedFile.name }}</div>
                    <div class="text-muted small">{{ humanSize(selectedFile.size) }}</div>
                </div>
                <button mat-icon-button color="warn" (click)="clearFile()" matTooltip="Xóa file" type="button">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>

        <input #fileInput type="file" accept=".zip,application/zip" style="display: none"
            (change)="onFileSelect($event)">
    </div>

    <div *ngIf="fileError" class="alert alert-danger mt-2 mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ fileError }}
    </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close type="button">Hủy</button>
    <button mat-flat-button color="primary" [disabled]="!canSubmit()" (click)="submit()" type="button">
        <mat-icon>upload</mat-icon>
        <span class="ms-1">Upload</span>
    </button>
</mat-dialog-actions>

<app-loading-screen *ngIf="loadingSubjects" [embedded]="true"></app-loading-screen>