<div class="container-fluid" [attr.aria-busy]="isLoading">
    <!-- Date filters + quick actions -->
    <div class="row g-2 align-items-end mb-3">
        <div class="col-12 col-md-3">
            <label class="form-label mb-1">Từ ngày</label>
            <mat-form-field appearance="outline" class="w-100 dense-field" subscriptSizing="dynamic">
                <input matInput [matDatepicker]="fromPicker" [formControl]="from">
                <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
                <mat-datepicker #fromPicker></mat-datepicker>
            </mat-form-field>
        </div>
        <div class="col-12 col-md-3">
            <label class="form-label mb-1">Đến ngày</label>
            <mat-form-field appearance="outline" class="w-100 dense-field" subscriptSizing="dynamic">
                <input matInput [matDatepicker]="toPicker" [formControl]="to">
                <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
                <mat-datepicker #toPicker></mat-datepicker>
            </mat-form-field>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary" (click)="resetRange()">Reset</button>
            <button class="btn btn-outline-primary" (click)="thisWeek()">Tuần này</button>
            <button class="btn btn-outline-primary" (click)="thisMonth()">Tháng này</button>
            <button class="btn btn-outline-primary" (click)="thisQuarter()">Quý này</button>
            <button class="btn btn-outline-primary" (click)="thisYear()">Năm nay</button>
            <button class="btn btn-primary ms-auto" (click)="reload()">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
            </button>
        </div>
    </div>

    <!-- Metric cards -->
    <div class="row g-3">
        <!-- Subjects -->
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="card-title text-muted small">MÔN PHỤ TRÁCH</div>
                    <div class="metric">{{ data?.subjects?.assigned ?? 0 }}</div>

                    <div class="text-muted small mt-2">Top đóng góp (5)</div>
                    <ul class="list-group list-group-flush small mt-1"
                        *ngIf="data?.subjects?.myContribTop?.length; else noTop">
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            *ngFor="let s of data?.subjects?.myContribTop">
                            <span class="text-truncate" style="max-width: 70%">{{ s.subjectName }}</span>
                            <span class="badge text-bg-light">
                                {{ s.myQuestions }} / {{ s.subjectTotal }}
                            </span>
                        </li>
                    </ul>
                    <ng-template #noTop>
                        <div class="text-muted small">Chưa có đóng góp nào trong khoảng đã chọn.</div>
                    </ng-template>
                </div>
            </div>
        </div>

        <!-- Questions -->
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="card-title text-muted small">CÂU HỎI CỦA TÔI</div>
                    <div class="metric">{{ data?.questions?.total ?? 0 }}</div>

                    <div class="row mt-2 small">
                        <!-- Theo loại -->
                        <div class="col-12">
                            <div class="fw-semibold">Theo loại</div>
                            <div>Trắc nghiệm: {{ data?.questions?.byType?.['MULTIPLE_CHOICE'] ?? 0 }}</div>
                            <div>Tự luận: {{ data?.questions?.byType?.['ESSAY'] ?? 0 }}</div>
                        </div>

                        <!-- Theo nhãn -->
                        <div class="col-12 mt-2">
                            <div class="fw-semibold">Theo nhãn</div>
                            <div>Ôn tập: {{ data?.questions?.byLabel?.['PRACTICE'] ?? 0 }}</div>
                            <div>Thi cử: {{ data?.questions?.byLabel?.['EXAM'] ?? 0 }}</div>
                        </div>
                        <div class="col-12 mt-2">
                            <div class="fw-semibold">Theo độ khó</div>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge rounded-pill bg-light border"
                                    *ngFor="let d of asEntries(data?.questions?.byDifficulty)">
                                    {{ d[0] }}: {{ d[1] }}
                                </span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Archive -->
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="card-title text-muted small">KHO ĐỀ CỦA TÔI</div>
                    <div class="metric">{{ (data?.archive?.pending ?? 0) + (data?.archive?.approved ?? 0) +
                        (data?.archive?.rejected ?? 0) }}</div>

                    <div class="d-flex gap-2 flex-wrap small mt-2">
                        <span class="badge rounded-pill text-bg-success">APP {{ data?.archive?.approved ?? 0 }}</span>
                        <span class="badge rounded-pill text-bg-warning text-dark">PEN {{ data?.archive?.pending ?? 0
                            }}</span>
                        <span class="badge rounded-pill text-bg-danger">REJ {{ data?.archive?.rejected ?? 0 }}</span>
                    </div>

                    <div class="small text-muted mt-2">
                        T/g duyệt TB: {{ fmtHours(data?.archive?.avgReviewHours) }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coverage + Pending soon -->
    <div class="row g-3 mt-2">
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="card-title text-muted small">Phủ chương (0–7)</div>

                    <div class="chapter-row" *ngFor="let i of [0,1,2,3,4,5,6,7]">
                        <div class="chapter-label">CHAPTER{{ i }}</div>
                        <div class="progress flex-fill" role="progressbar" aria-label="coverage">
                            <div class="progress-bar"
                                [style.width.%]="barPercent(data?.coverage?.['chapter' + i], totalQuestions)">
                            </div>
                        </div>
                        <div class="chapter-count ms-2">{{ data?.coverage?.['chapter' + i] ?? 0 }}</div>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="card-title text-muted small">PENDING gần đến hạn</div>

                    <div *ngIf="data?.archive?.pendingSoon?.length; else noPending" class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr class="text-muted small">
                                    <th>File</th>
                                    <th>Môn</th>
                                    <th>Loại</th>
                                    <th>Hạn</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let f of data?.archive?.pendingSoon">
                                    <td class="text-truncate" style="max-width: 260px">{{ f.filename }}</td>
                                    <td>{{ f.subjectName || '—' }}</td>
                                    <td><span class="badge text-bg-info">{{ f.variant || '—' }}</span></td>
                                    <td>
                                        <span *ngIf="f.reviewDeadline; else noDl">
                                            {{ (f.reviewDeadline | date:'dd/MM, HH:mm') }}
                                        </span>
                                        <ng-template #noDl>—</ng-template>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <ng-template #noPending>
                        <div class="text-muted small">Không có file pending nào gần đến hạn.</div>
                    </ng-template>

                </div>
            </div>
        </div>
    </div>

    <app-loading-screen *ngIf="isLoading"></app-loading-screen>
</div>