<div class="container-fluid" [attr.aria-busy]="isLoading">
  <!-- Date filters + quick actions -->
  <div class="row g-2 align-items-end mb-3">
    <div class="col-12 col-md-3">
      <label class="form-label mb-1">Từ ngày</label>
      <mat-form-field appearance="outline" class="w-100 compact-mat" subscriptSizing="dynamic">
        <input matInput [matDatepicker]="fromPicker" [formControl]="from">
        <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
        <mat-datepicker #fromPicker></mat-datepicker>
      </mat-form-field>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label mb-1">Đến ngày</label>
      <mat-form-field appearance="outline" class="w-100 compact-mat" subscriptSizing="dynamic">
        <input matInput [matDatepicker]="toPicker" [formControl]="to">
        <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
        <mat-datepicker #toPicker></mat-datepicker>
      </mat-form-field>
    </div>
    <div class="col-12 col-md-6 d-flex flex-wrap gap-2">
      <button class="btn btn-outline-secondary" (click)="resetRange()">Reset</button>
      <button class="btn btn-outline-primary" (click)="thisWeek()">Tuần này</button>
      <button class="btn btn-outline-primary" (click)="thisMonth()">Tháng này</button>
      <button class="btn btn-outline-primary" (click)="thisQuarter()">Quý này</button>
      <button class="btn btn-outline-primary" (click)="thisYear()">Năm nay</button>
      <button class="btn btn-primary ms-auto" (click)="reload()">
        <i class="bi bi-arrow-clockwise"></i> Tải lại
      </button>
    </div>
  </div>

  <!-- Metric cards -->
  <div class="row g-3">
    <!-- Môn phụ trách -->
    <div class="col-12 col-lg-4">
      <div class="card kpi shadow-sm h-100">
        <div class="card-body">
          <div class="kpi-title">Môn phụ trách</div>
          <div class="kpi-value">{{ data?.subjects?.assigned ?? 0 }}</div>

          <div class="kpi-sub text-muted mt-2">Top đóng góp (5)</div>
          <ng-container *ngIf="(data?.subjects?.myContribTop?.length ?? 0) > 0; else noTop">
            <div #contribRef class="w-100"></div>
          </ng-container>
          <ng-template #noTop>
            <div class="kpi-sub text-muted">Chưa có đóng góp nào trong khoảng đã chọn.</div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Câu hỏi của tôi -->
    <div class="col-12 col-lg-4">
      <div class="card kpi shadow-sm h-100">
        <div class="card-body">
          <div class="kpi-title">Câu hỏi của tôi</div>
          <div class="kpi-value">{{ data?.questions?.total ?? 0 }}</div>

          <div class="row g-2 mt-2">
            <div class="col-6">
              <div class="small text-muted mb-1">Theo loại</div>
              <div #typeDonutRef class="w-100 chart-square chart-center"></div>
            </div>
            <div class="col-6">
              <div class="small text-muted mb-1">Theo nhãn</div>
              <div #labelDonutRef class="w-100 chart-square chart-center"></div>
            </div>
            <div class="col-12">
              <div class="small text-muted mb-1">Theo độ khó</div>
              <div #difficultyRef class="w-100 chart-square chart-center"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Kho đề của tôi -->
    <div class="col-12 col-lg-4">
      <div class="card kpi shadow-sm h-100">
        <div class="card-body">
          <div class="kpi-title">Kho đề của tôi</div>
          <div class="kpi-value">
            {{ (data?.archive?.pending ?? 0) + (data?.archive?.approved ?? 0) + (data?.archive?.rejected ?? 0) }}
          </div>

          <div class="mt-2">
            <div #archiveDonutRef class="w-100 chart-square chart-center"></div>
          </div>

          <div class="kpi-sub d-flex gap-2 flex-wrap mt-2">
            <span class="badge rounded-pill text-bg-success">APP {{ data?.archive?.approved ?? 0 }}</span>
            <span class="badge rounded-pill text-bg-warning text-dark">PEN {{ data?.archive?.pending ?? 0 }}</span>
            <span class="badge rounded-pill text-bg-danger">REJ {{ data?.archive?.rejected ?? 0 }}</span>
            <span class="text-muted ms-auto">T/g duyệt TB: {{ fmtHours(data?.archive?.avgReviewHours) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Coverage + Pending soon -->
  <div class="row g-3 mt-2">
    <div class="col-12 col-lg-6">
      <div class="card kpi shadow-sm h-100">
        <div class="card-body">
          <div class="kpi-title">Phủ chương (0–7)</div>
          <div #coverageRef class="w-100"></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card kpi shadow-sm h-100">
        <div class="card-body">
          <div class="kpi-title">Pending gần đến hạn</div>
          <div *ngIf="data?.archive?.pendingSoon?.length; else noPending" class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr class="text-muted small">
                  <th>File</th>
                  <th>Môn</th>
                  <th>Loại</th>
                  <th>Hạn</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let f of data?.archive?.pendingSoon">
                  <td class="text-truncate" style="max-width: 260px">{{ f.filename }}</td>
                  <td>{{ f.subjectName || '—' }}</td>
                  <td><span class="badge text-bg-info">{{ f.variant || '—' }}</span></td>
                  <td>
                    <span *ngIf="f.reviewDeadline; else noDl">
                      {{ (f.reviewDeadline | date:'dd/MM, HH:mm') }}
                    </span>
                    <ng-template #noDl>—</ng-template>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noPending>
            <div class="text-muted small">Không có file pending nào gần đến hạn.</div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <app-loading-screen *ngIf="isLoading"></app-loading-screen>
</div>
